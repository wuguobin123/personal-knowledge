{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/wuxiaomu/one-person/personal-knowledge/src/lib/auth.ts"],"sourcesContent":["import { jwtVerify, SignJWT } from \"jose\";\nimport { cookies } from \"next/headers\";\n\nexport const ADMIN_SESSION_COOKIE = \"admin_session\";\n\ntype AdminSession = {\n  username: string;\n};\n\nfunction getAuthSecret() {\n  const secret = process.env.AUTH_SECRET;\n  if (!secret || secret.length < 16) {\n    throw new Error(\"AUTH_SECRET is not set or too short.\");\n  }\n  return new TextEncoder().encode(secret);\n}\n\nexport async function createAdminSessionToken(username: string) {\n  return new SignJWT({ role: \"admin\" })\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setSubject(username)\n    .setIssuedAt()\n    .setExpirationTime(\"7d\")\n    .sign(getAuthSecret());\n}\n\nexport async function verifyAdminSessionToken(token: string): Promise<AdminSession | null> {\n  try {\n    const { payload } = await jwtVerify(token, getAuthSecret());\n    if (payload.role !== \"admin\" || typeof payload.sub !== \"string\") {\n      return null;\n    }\n    return { username: payload.sub };\n  } catch {\n    return null;\n  }\n}\n\nexport async function getAdminSession(): Promise<AdminSession | null> {\n  const cookieStore = await cookies();\n  const token = cookieStore.get(ADMIN_SESSION_COOKIE)?.value;\n  if (!token) {\n    return null;\n  }\n  return verifyAdminSessionToken(token);\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;AACA;;;AAEO,MAAM,uBAAuB;AAMpC,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,WAAW;IACtC,IAAI,CAAC,UAAU,OAAO,MAAM,GAAG,IAAI;QACjC,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAI,cAAc,MAAM,CAAC;AAClC;AAEO,eAAe,wBAAwB,QAAgB;IAC5D,OAAO,IAAI,kKAAO,CAAC;QAAE,MAAM;IAAQ,GAChC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,UAAU,CAAC,UACX,WAAW,GACX,iBAAiB,CAAC,MAClB,IAAI,CAAC;AACV;AAEO,eAAe,wBAAwB,KAAa;IACzD,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO;QAC3C,IAAI,QAAQ,IAAI,KAAK,WAAW,OAAO,QAAQ,GAAG,KAAK,UAAU;YAC/D,OAAO;QACT;QACA,OAAO;YAAE,UAAU,QAAQ,GAAG;QAAC;IACjC,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,uBAAuB;IACrD,IAAI,CAAC,OAAO;QACV,OAAO;IACT;IACA,OAAO,wBAAwB;AACjC"}},
    {"offset": {"line": 101, "column": 0}, "map": {"version":3,"sources":["file:///Users/wuxiaomu/one-person/personal-knowledge/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma?: PrismaClient;\n};\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalForPrisma.prisma = prisma;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,sMAAY;AAEhE,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 116, "column": 0}, "map": {"version":3,"sources":["file:///Users/wuxiaomu/one-person/personal-knowledge/src/app/api/articles/route.ts"],"sourcesContent":["import { Prisma, type ArticleSourceType } from \"@prisma/client\";\nimport { getAdminSession } from \"@/lib/auth\";\nimport { prisma } from \"@/lib/prisma\";\n\nfunction toSlug(input: string) {\n  return input\n    .trim()\n    .toLowerCase()\n    .replace(/[\\s_]+/g, \"-\")\n    .replace(/[^a-z0-9-]/g, \"\")\n    .replace(/-+/g, \"-\")\n    .replace(/^-|-$/g, \"\");\n}\n\nconst sourceTypeSet = new Set<ArticleSourceType>([\n  \"ORIGINAL\",\n  \"CRAWLER\",\n  \"TRANSCRIPT\",\n]);\n\nfunction normalizeCategory(input: unknown) {\n  const category = String(input ?? \"\").trim();\n  return (category || \"未分类\").slice(0, 80);\n}\n\nfunction normalizeTags(input: unknown) {\n  const raw = Array.isArray(input)\n    ? input\n    : typeof input === \"string\"\n      ? input.split(/[,，\\n]/g)\n      : [];\n  const tags = new Set<string>();\n\n  for (const item of raw) {\n    const tag = String(item ?? \"\").trim().slice(0, 40);\n    if (tag) {\n      tags.add(tag);\n    }\n  }\n\n  return Array.from(tags).slice(0, 12);\n}\n\nfunction normalizeSourceType(input: unknown): ArticleSourceType {\n  const sourceType = String(input ?? \"\").trim().toUpperCase() as ArticleSourceType;\n  return sourceTypeSet.has(sourceType) ? sourceType : \"ORIGINAL\";\n}\n\nfunction normalizeSourceDetail(input: unknown) {\n  const detail = String(input ?? \"\").trim().slice(0, 500);\n  return detail || null;\n}\n\nfunction jsonToTags(tags: Prisma.JsonValue | null) {\n  if (!Array.isArray(tags)) {\n    return [];\n  }\n\n  return tags\n    .filter((tag): tag is string => typeof tag === \"string\")\n    .map((tag) => tag.trim())\n    .filter(Boolean);\n}\n\nexport async function GET() {\n  const articles = await prisma.article.findMany({\n    where: { published: true },\n    orderBy: { publishedAt: \"desc\" },\n    select: {\n      id: true,\n      title: true,\n      slug: true,\n      category: true,\n      tags: true,\n      sourceType: true,\n      sourceDetail: true,\n      excerpt: true,\n      publishedAt: true,\n    },\n  });\n\n  return Response.json(\n    articles.map((article) => ({\n      ...article,\n      tags: jsonToTags(article.tags),\n    })),\n  );\n}\n\nexport async function POST(request: Request) {\n  const session = await getAdminSession();\n  if (!session) {\n    return Response.json({ error: \"Unauthorized.\" }, { status: 401 });\n  }\n\n  const payload = await request.json();\n  const title = String(payload.title || \"\").trim();\n  const excerpt = String(payload.excerpt || \"\").trim();\n  const content = String(payload.content || \"\").trim();\n  const published = payload.published !== false;\n  const customSlug = String(payload.slug || \"\").trim();\n  const category = normalizeCategory(payload.category);\n  const tags = normalizeTags(payload.tags);\n  const sourceType = normalizeSourceType(payload.sourceType);\n  const sourceDetail = normalizeSourceDetail(payload.sourceDetail);\n  const normalizedSlug = customSlug ? toSlug(customSlug) : toSlug(title);\n  const slug = normalizedSlug || `article-${Date.now()}`;\n\n  if (!title || !excerpt || !content) {\n    return Response.json(\n      { error: \"title/excerpt/content are required.\" },\n      { status: 400 },\n    );\n  }\n\n  try {\n    const article = await prisma.article.create({\n      data: {\n        title,\n        slug,\n        category,\n        tags: tags.length > 0 ? tags : null,\n        sourceType,\n        sourceDetail,\n        excerpt,\n        content,\n        published,\n      },\n      select: {\n        id: true,\n        title: true,\n        slug: true,\n        category: true,\n        tags: true,\n        sourceType: true,\n        sourceDetail: true,\n      },\n    });\n\n    return Response.json(\n      { ...article, tags: jsonToTags(article.tags) },\n      { status: 201 },\n    );\n  } catch (error) {\n    if (\n      error instanceof Prisma.PrismaClientKnownRequestError &&\n      error.code === \"P2002\"\n    ) {\n      return Response.json(\n        { error: `slug \"${slug}\" already exists.` },\n        { status: 409 },\n      );\n    }\n\n    return Response.json({ error: \"Failed to create article.\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}